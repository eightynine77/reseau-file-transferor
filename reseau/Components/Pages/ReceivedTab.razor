@page "/received"
@inject Services.FileTransferService NetService
@implements IDisposable

<h3 class="mb-3">Inbox</h3>

<div class="card p-3 mb-3" style="background-color: #f0f0f0;">
    <label class="fw-bold">Save Location:</label>
    <div class="text-break mb-2 text-muted">
        @currentSavePath
    </div>
    <button class="btn btn-outline-primary btn-sm" @onclick="ChangeFolder">
         Change Folder
    </button>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
    <span>Received Files:</span>
    <button class="btn btn-sm btn-secondary" @onclick="RefreshFiles">Refresh</button>
</div>

@if (receivedFiles.Any())
{
    <div class="list-group">
        @foreach (var file in receivedFiles)
        {
            <div class="list-group-item">
                <span class="fw-bold">@file.Name</span>
                <br />
                <small class="text-muted">@file.SizeString</small>
            </div>
        }
    </div>
}
else
{
    <div class="alert alert-light text-center border">
        <p class="mb-0">No files received yet.</p>
    </div>
}


@code {
    private string currentSavePath;
    private List<string> receivedFiles = new List<string>();

    protected override void OnInitialized()
    {
        currentSavePath = NetService.ReceivedFilesPath;
        NetService.OnFileReceived += HandleFileReceived;
        RefreshFiles();
    }

    private async Task ChangeFolder()
    {
        // Call the service to pick a folder
        string newPath = await NetService.PickSaveLocationAsync();

        if (!string.IsNullOrEmpty(newPath))
        {
            currentSavePath = newPath;
            RefreshFiles(); // Reload list from new folder
        }
    }

    private void RefreshFiles()
    {
        try
        {
            var directory = NetService.ReceivedFilesPath;
            if (Directory.Exists(directory))
            {
                receivedFiles = Directory.GetFiles(directory)
                                         .Select(Path.GetFileName)
                                         .ToList();
            }
            else
            {
                receivedFiles.Clear();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading files: {ex.Message}");
        }
    }

    // This method is called by the event from the service
    private async void HandleFileReceived()
    {
        // We are on a background thread, so we must invoke StateHasChanged
        // on the UI thread.
        await InvokeAsync(() =>
        {
            RefreshFiles();
            StateHasChanged();
        });
    }

    // Unsubscribe from the event when the page is closed
    public void Dispose()
    {
        NetService.OnFileReceived -= HandleFileReceived;
    }
}